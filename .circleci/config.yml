version: 2.1

dependencies: &dependencies
  name: Install Dependencies
  command: pip install awscli --upgrade

orbs:
  sam: circleci/aws-sam-serverless@2.1.0

jobs:
  compile_with_typescript:
    working_directory: ~/blog-server
    docker:
      - image: node:15.3.0
    steps:
      - checkout
      - run:
          name: Install Typescript
          command: npm install typescript
      - run:
          name: Compile
          command: npm run compile
      - persist_to_workspace:
          root: ~/blog-server
          paths: .

  build_lambda_layer:
    working_directory: ~/blog-server/src/lambda-layer
    docker:
      - image: node:15.3.0
    steps:
      - run:
          name: Install Packages
          command: npm install
      - persist_to_workspace:
          root: ~/blog-server/src/lambda-layer
          paths: .

  deploy_lambda_layer:
    working_directory: ~/blog-server/src/lambda-layer
    docker:
      - image: cimg/python:3.7
    steps:
      - run:
          <<: *dependencies
      - run:
          name: Deploy Layer
          command: ./../../deployment/deployLambdaLayer.sh

workflows:
  build-and-deploy:
    jobs:
      - compile_with_typescript
      - build_lambda_layer:
          requires:
            - compile_with_typescript
      - deploy_lambda_layer:
          requires:
            - build_lambda_layer
      - sam/deploy:
          name: deploy
          context:
            - BLOG_PROD
          stack-name: blog-server
          template: template.yml
          s3-bucket: jbasten-serverless-artifacts
          requires:
            - deploy_lambda_layer